<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta name="theme-color" content="#5A9AD4"/>
    <title th:text="${trip.name} + ' — Repartija'">Viaje — Repartija</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&display=swap" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link th:href="@{/css/app.css}" rel="stylesheet"/>
    <style>input, select, textarea{font-size:16px}.nav-tabs .nav-link{padding:.6rem 1rem}.btn,.nav-tabs .nav-link{min-height:44px;display:inline-flex;align-items:center;justify-content:center}</style>
</head>
<body class="pb-4">
<div class="container app-container py-3 py-md-4">
    <nav class="app-nav mb-3">
        <a th:href="@{/}">← Inicio</a>
    </nav>
    <h1 class="app-title" th:text="${trip.name}">Viaje</h1>

    <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-personas" data-bs-toggle="tab" data-bs-target="#panel-personas" type="button" role="tab" th:classappend="${activeTab != 'gastos'} ? 'active' : ''">Personas</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-gastos" data-bs-toggle="tab" data-bs-target="#panel-gastos" type="button" role="tab" th:classappend="${activeTab == 'gastos'} ? 'active' : ''">Gastos</button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- Pestaña Personas -->
        <div class="tab-pane fade" id="panel-personas" role="tabpanel" th:classappend="${activeTab != 'gastos'} ? 'show active' : ''">
            <form th:action="@{/trips/{id}/people(id=${trip.id})}" method="post" class="row g-2 mb-3">
                <div class="col-12 col-sm-auto flex-grow-1">
                    <label for="personName" class="form-label">Nombre</label>
                    <input id="personName" name="name" type="text" class="form-control" placeholder="Nombre" required/>
                </div>
                <div class="col-12 col-sm-auto d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Agregar persona</button>
                </div>
            </form>
            <p th:if="${#lists.isEmpty(people)}" class="text-muted">Aún no hay personas. Agrega al menos una para registrar gastos.</p>
            <ul th:unless="${#lists.isEmpty(people)}" class="list-group">
                <li th:each="p : ${people}" class="list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <span th:text="${p.name}">Persona</span>
                    <div class="d-flex gap-1">
                        <a th:href="@{/trips/{tripId}/people/{personId}/edit(tripId=${trip.id}, personId=${p.id})}" class="btn btn-outline-secondary btn-sm">Editar</a>
                        <a th:href="@{/trips/{tripId}/people/{personId}/confirm-delete(tripId=${trip.id}, personId=${p.id})}" class="btn btn-outline-danger btn-sm">Eliminar</a>
                    </div>
                </li>
            </ul>
        </div>

        <!-- Pestaña Gastos -->
        <div class="tab-pane fade" id="panel-gastos" role="tabpanel" th:classappend="${activeTab == 'gastos'} ? 'show active' : ''">
            <form th:action="@{/trips/{id}/expenses(id=${trip.id})}" th:object="${expenseForm}" method="post" class="mb-4">
                <div class="row g-2 mb-2">
                    <div class="col-12 col-md-4">
                        <label for="description" class="form-label">Descripción</label>
                        <input id="description" th:field="*{description}" class="form-control" placeholder="Ej: Coca Cola"/>
                        <div th:if="${#fields.hasErrors('description')}" th:errors="*{description}" class="text-danger small"></div>
                    </div>
                    <div class="col-6 col-md-2">
                        <label for="amount" class="form-label">Monto total</label>
                        <input id="amount" th:field="*{amount}" type="number" step="0.01" min="0.01" class="form-control" required/>
                        <div th:if="${#fields.hasErrors('amount')}" th:errors="*{amount}" class="text-danger small"></div>
                    </div>
                    <div class="col-6 col-md-3">
                        <label for="paidById" class="form-label">Pagó</label>
                        <select id="paidById" th:field="*{paidById}" class="form-select" required>
                            <option value="">Quién pagó</option>
                            <option th:each="p : ${people}" th:value="${p.id}" th:text="${p.name}">Persona</option>
                        </select>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label">¿Entre quiénes se divide? (marcar al menos una)</label>
                    <div th:if="${#lists.isEmpty(people)}" class="text-muted">Agrega personas en la pestaña Personas primero.</div>
                    <div th:unless="${#lists.isEmpty(people)}" class="d-flex flex-wrap gap-2">
                        <div th:each="p : ${people}" class="form-check">
                            <input type="checkbox" th:field="*{participantIds}" th:value="${p.id}" class="form-check-input" th:id="${'p-' + p.id}"/>
                            <label th:for="${'p-' + p.id}" class="form-check-label" th:text="${p.name}">Persona</label>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Registrar gasto</button>
            </form>

            <hr class="my-3"/>
            <p th:if="${#lists.isEmpty(expenses)}" class="text-muted">No hay gastos registrados.</p>
            <div th:unless="${#lists.isEmpty(expenses)}" class="table-responsive">
            <table class="table table-sm">
                <thead>
                <tr>
                    <th>Descripción</th>
                    <th>Monto</th>
                    <th>Pagó</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="e : ${expenses}">
                    <td th:text="${e.description}">desc</td>
                    <td th:text="${#numbers.formatDecimal(e.amount, 1, 2)}">0.00</td>
                    <td th:text="${e.paidBy.name}">nombre</td>
                </tr>
                </tbody>
            </table>
            </div>
        </div>
    </div>

    <p class="mt-4">
        <a th:href="@{/trips/{id}/summary(id=${trip.id})}" class="btn btn-success">Ver resumen de saldos</a>
    </p>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
